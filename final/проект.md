# Настройка сбора логов на основе fluentbit и базы opensearch

## 1.Сбор логов сервера 1с

Для начала необходимо настроить 1с для сбора логов технологического журнала.
Это делается при помощи файла logcfg.xml

![logcfg.xml](1с/logcfg.xml)
Этот файл необходимо настроить на сбор необходимой информации, в проекте он настроен на данные по утечке памяти, т.к. была проблема и копали по ней. Через 2 минуты после появления файла в папке /home/usr1cv8/.1cv8/1C/1cv8/conf/ сервера сервер начинает логгирование.

Объем логов на этом сервере за 2 часа:

```bash
du -h /var/log/1c1/logs
785M    /var/log/1c1/logs
```

> Внимание. вся эта сборка подходит только к версии 1с сервера старше 8.3.25, т.к. только тут начали применять формат json в логах и плоское расположение файлов.

Для примера выложил формат выходного файла с логами 
![example.log](1с/example.log)

## 2. Установка docker, portainer и запуск opensearch

### 2.1 Установка docker

Система у нас ubuntu 24.04

```bash
sudo apt install apt-transport-https ca-certificates curl software-properties-common -y
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

Проверяем, что все установилось правильно

```bash
docker --version
Docker version 27.4.0, build bde2b89
```

### 2.1 Установка portainer

```bash
docker volume create portainer_data
docker run -d -p 9000:9000 -p 9443:9443 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce:latest
```
Заходим на адрес http://192.168.5.197:9000/#!/home делаем предварительную настройку.

### 2.3 Установка opensearch и opensearch dashboards
В portainer создаем новый stack, добавляем в поле редактора содержимое файла [docker-compose.yml](docker-compose.yml)
![docker-compose.yml](docker-compose.yml)


2. Отправьте несколько сообщений используя утилиту kafka-producer
![Отправка](img/2024-12-24_17-23-45.png)
3. Прочитайте их, используя графический интерфейс или утилиту kafka-consumer
![Получение](img/2024-12-24_17-35-28.png)
4. Отправьте и прочитайте сообщения программно - выберите знакомый язык программирования (C#, Java, Python или любой другой, для которого есть библиотека для работы с Kafka), отправьте и прочитайте несколько сообщений
![Отправка и получение с помощью программы](img/2024-12-24_18-24-19.png)
